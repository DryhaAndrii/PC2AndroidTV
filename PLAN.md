# План разработки TV Media Server приложения

## Обзор проекта
TV приложение на React Native (Expo TV) для просмотра медиа контента с локальных серверов в сети. Сервер на Express.js предоставляет доступ к выбранной папке через веб-интерфейс.

---

## Этап 1: Настройка Backend сервера

### 1.1 Инициализация проекта
- [x] Создать `Backend/package.json` с зависимостями
- [x] Установить зависимости: express, cors, mime-types, bonjour (для обнаружения), dotenv
- [x] Создать `.env.example` файл с настройками:
  - `PORT=3000` (порт сервера)
  - `SERVER_NAME=` (имя сервера, если пусто - использовать hostname)
  - `SELECTED_FOLDER=` (путь к выбранной папке, изначально пусто)

### 1.2 Базовая структура сервера
- [x] Создать `Backend/server.js` - основной файл сервера
- [x] Настроить Express с CORS для разрешения запросов с TV приложения
- [x] Создать структуру папок:
  - `Backend/routes/` - маршруты API
  - `Backend/services/` - сервисы (обнаружение, сканирование файлов)
  - `Backend/public/` - статические файлы для веб-интерфейса

### 1.3 mDNS/Bonjour для обнаружения серверов
- [x] Настроить mDNS сервис для анонса сервера в сети
- [x] Реализовать broadcast сервис с именем из env или hostname
- [x] Обеспечить автоматическую регистрацию при запуске сервера

---

## Этап 2: Веб-интерфейс для выбора папки

### 2.1 Веб-страница выбора папки
- [x] Создать `Backend/public/index.html` - веб-интерфейс
- [x] Реализовать ввод пути к папке через текстовое поле
- [x] Отобразить выбранную папку и её путь
- [x] Кнопка "Сохранить" для подтверждения выбора
- [x] Показать статус сервера (запущен, папка выбрана)

### 2.2 API для работы с папкой
- [x] `POST /api/folder/select` - сохранение выбранной папки
- [x] `GET /api/folder/status` - получение статуса (выбрана ли папка, путь)
- [x] Валидация выбранной папки

---

## Этап 3: API для получения файлов

### 3.1 Сканирование файлов
- [x] Создать функцию сканирования в `Backend/routes/files.js`
- [x] Функция для рекурсивного сканирования выбранной папки
- [x] Фильтрация только изображений (jpg, jpeg, png)
- [x] Генерация уникальных ID для каждого файла (base64url)
- [x] Сбор метаданных (имя, размер, путь, тип, mimeType)

### 3.2 API эндпоинты
- [x] `GET /api/discover` - информация о сервере для обнаружения
  - Возвращает: имя, версия, порт, статус
- [x] `GET /api/files` - список всех файлов
  - Возвращает массив файлов с метаданными
- [x] `GET /api/files/:id` - получение конкретного файла
  - Отправка файла с правильными headers (Content-Type, Content-Length)
- [x] `GET /api/files/:id/info` - метаданные файла

### 3.3 Обработка ошибок
- [x] Обработка случая когда папка не выбрана
- [x] Обработка несуществующих файлов
- [x] Валидация путей (безопасность - предотвращение path traversal)

---

## Этап 4: Обнаружение серверов в TV приложении

### 4.1 Установка зависимостей
- [ ] Добавить библиотеки для обнаружения:
  - `react-native-zeroconf` или `bonjour-service` (если доступно)
  - Или использовать UDP broadcast через `react-native-udp`
- [ ] Добавить библиотеку для HTTP запросов: `axios` или `fetch`

### 4.2 Сервис обнаружения серверов
- [ ] Создать `RNApp/services/serverDiscovery.ts`
- [ ] Реализовать сканирование mDNS сервисов `_mytvserver._tcp.local`
- [ ] Реализовать UDP broadcast запросы как fallback
- [ ] Периодическое обновление списка серверов
- [ ] Хранение списка найденных серверов

### 4.3 UI для выбора сервера
- [ ] Создать экран `RNApp/app/servers.tsx`
- [ ] Отображение списка найденных серверов
- [ ] Индикация статуса (поиск, найдено, ошибка)
- [ ] Кнопка "Обновить" для повторного сканирования
- [ ] Выбор сервера и переход к просмотру контента

---

## Этап 5: Отображение изображений в TV приложении

### 5.1 API сервис для работы с сервером
- [ ] Создать `RNApp/services/api.ts`
- [ ] Функции для запросов к серверу:
  - `getServerInfo(serverUrl)` - информация о сервере
  - `getFiles(serverUrl)` - список файлов
  - `getFileUrl(serverUrl, fileId)` - URL для получения файла

### 5.2 Хранение состояния
- [ ] Создать контекст или использовать состояние для:
  - Выбранного сервера
  - Списка файлов
  - Текущего просмотра

### 5.3 Экран галереи изображений
- [ ] Создать `RNApp/app/gallery.tsx`
- [ ] Grid layout для отображения изображений
- [ ] Использовать `Image` компонент React Native для загрузки
- [ ] Поддержка навигации с TV пульта (фокус, выбор)
- [ ] Индикация загрузки изображений

### 5.4 Экран просмотра изображения
- [ ] Создать `RNApp/app/viewer.tsx`
- [ ] Fullscreen просмотр выбранного изображения
- [ ] Навигация между изображениями (вперед/назад)
- [ ] Zoom функциональность (опционально)
- [ ] Информация о файле (имя, размер)

---

## Этап 6: Навигация и роутинг

### 6.1 Настройка роутинга
- [ ] Обновить `RNApp/app/_layout.tsx` для настройки навигации
- [ ] Определить структуру экранов:
  - `/` - главный экран (выбор сервера)
  - `/gallery` - галерея файлов
  - `/viewer/:fileId` - просмотр файла

### 6.2 Навигация с TV пульта
- [ ] Обеспечить правильную навигацию между экранами
- [ ] Обработка кнопок пульта (Back, Home)
- [ ] Фокус на элементах для TV интерфейса

---

## Этап 7: Обработка ошибок и edge cases

### 7.1 Обработка ошибок сети
- [ ] Обработка недоступности сервера
- [ ] Retry логика для запросов
- [ ] Понятные сообщения об ошибках пользователю

### 7.2 Обработка больших файлов
- [ ] Оптимизация загрузки больших изображений
- [ ] Lazy loading для галереи
- [ ] Показ прогресса загрузки

### 7.3 Валидация и безопасность
- [ ] Валидация URL серверов
- [ ] Проверка доступности сервера перед подключением
- [ ] Обработка невалидных ответов от сервера

---

## Этап 8: Тестирование и отладка

### 8.1 Тестирование сервера
- [ ] Проверить работу mDNS/broadcast
- [ ] Протестировать выбор папки через веб-интерфейс
- [ ] Проверить API эндпоинты
- [ ] Тестирование с большим количеством файлов

### 8.2 Тестирование TV приложения
- [ ] Проверить обнаружение серверов
- [ ] Тестирование на реальном TV устройстве
- [ ] Проверить навигацию с пульта
- [ ] Тестирование загрузки и отображения изображений

### 8.3 Интеграционное тестирование
- [ ] Запуск нескольких серверов одновременно
- [ ] Проверка работы в разных сетях
- [ ] Тестирование с различными типами изображений

---

## Этап 9: Документация и финализация

### 9.1 README файлы
- [ ] `Backend/README.md` - инструкция по запуску сервера
- [ ] Обновить `RNApp/README.md` - инструкция по запуску TV приложения
- [ ] Общий `README.md` в корне проекта

### 9.2 Конфигурация
- [ ] Пример `.env.example` для Backend
- [ ] Документация по настройке

---

## Будущие улучшения (после базовой реализации)

- [ ] Поддержка видео файлов
- [ ] Поддержка аудио файлов
- [ ] Потоковая передача (streaming) для больших файлов
- [ ] Кэширование на клиенте
- [ ] Поддержка подпапок и навигации по папкам
- [ ] Поиск файлов
- [ ] Слайдшоу для изображений
- [ ] Автоматическое обновление списка файлов при изменениях

---

## Технический стек

### Backend
- Node.js + Express.js
- mDNS/Bonjour для обнаружения
- CORS для разрешения запросов
- MIME types для определения типов файлов

### TV App (RNApp)
- React Native (Expo TV)
- TypeScript
- Expo Router для навигации
- Библиотеки для обнаружения серверов
- Axios/Fetch для HTTP запросов

---

## Порядок выполнения

Рекомендуемый порядок:
1. **Этап 1** - Настройка Backend сервера (базовая структура)
2. **Этап 2** - Веб-интерфейс для выбора папки
3. **Этап 3** - API для получения файлов
4. **Этап 4** - Обнаружение серверов в TV приложении
5. **Этап 5** - Отображение изображений
6. **Этап 6** - Навигация и роутинг
7. **Этап 7** - Обработка ошибок
8. **Этап 8** - Тестирование
9. **Этап 9** - Документация

---

## Примечания

- Все чекпоинты можно отмечать по мере выполнения
- Можно работать параллельно над разными этапами где это возможно
- Приоритет - сначала базовый функционал, потом улучшения

